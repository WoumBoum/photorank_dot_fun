{% extends "base.html" %}

{% block content %}
<div class="container" data-init-app>
    <header>
        <h1>Your Stats</h1>
        <nav>
            <a href="/">Vote</a>
            <a href="/leaderboard">Leaderboard</a>
            <a href="/upload">Upload</a>
            <a href="/categories">Categories</a>
            <a href="/analytics" id="analytics-link" style="border:1px solid #e0e0e0; padding:0.25rem 0.5rem; margin-right:0.5rem; font-family:'Courier New', monospace;">Analytics (moderator)</a>
            <a href="/login" id="auth-link">Login</a>
            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">‚óê</button>
        </nav>
    </header>

    <script>
    // Hide Analytics link for non-moderators
    document.addEventListener('DOMContentLoaded', async function(){
      try{
        const link = document.getElementById('analytics-link');
        if(!link) return;
        const t = localStorage.getItem('token');
        if(!t){ link.remove(); return; }
        const res = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer '+t } });
        if(!res.ok){ link.remove(); return; }
        const me = await res.json();
        if(!me.is_moderator) link.remove();
      }catch(_){ try{ document.getElementById('analytics-link')?.remove(); }catch(e){} }
    });
    </script>
 
    <div class="stats-section">
        <h2>Your Pseudonym</h2>
        <div style="margin: 1rem 0;">
            <input id="pseudo-input" type="text" placeholder="enter new pseudonym"
                   style="font-family: 'Courier New', monospace; padding: 0.5rem; border: 1px solid #e0e0e0; width: 260px;" />
            <button id="pseudo-save" class="btn" style="margin-left: 0.5rem;">Save</button>
            <span id="pseudo-status" style="margin-left: 0.5rem; font-size: 0.9rem;"></span>
        </div>
        <h2>Your Photos</h2>
        <div class="stats-grid" id="stats-grid">
            <!-- Stats will be loaded here -->
        </div>
        <h2>Your Categories</h2>
        <div id="your-categories" style="margin-top:12px;font-size:0.95em;color:#333;"></div>
        <script>
        document.addEventListener('DOMContentLoaded', async function(){
          try{
            const token = localStorage.getItem('token');
            if(!token) return;
            const me = await (await fetch('/api/users/me', {headers:{'Authorization':'Bearer '+token}})).json();
            const cats = await (await fetch('/api/categories', {headers:{'Authorization':'Bearer '+token}})).json();
            const mine = cats.filter(c=>c.owner_id===me.id);
            const container = document.getElementById('your-categories');
            if(!mine.length){container.textContent='No categories yet.';return;}
            container.innerHTML = mine.map(c=>`<div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                <a href="/${encodeURIComponent(c.name)}/leaderboard" style="flex:1 1 auto;">${c.name}</a>
                <span style="flex:2 1 auto; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${c.question}</span>
                <button class="category-delete-btn" data-category-id="${c.id}">Delete</button>
            </div>`).join('');

            // Wire deletion for category owners
            container.querySelectorAll('button.delete-btn').forEach(btn=>{
              btn.addEventListener('click', async (ev)=>{
                ev.preventDefault();
                ev.stopPropagation();
                const id = btn.getAttribute('data-category-id');
                const name = btn.parentElement?.querySelector('a')?.textContent || 'this category';
                if(!confirm(`Delete category "${name}"? This will remove all its photos and votes.`)) return;
                try{
                  const res = await fetch(`/api/categories/${id}`, { method:'DELETE', headers:{'Authorization':'Bearer '+token}});
                  if(res.ok){ btn.parentElement?.remove(); }
                  else{ const d = await res.json().catch(()=>({detail:'Failed'})); alert(d.detail || 'Delete failed'); }
                }catch(e){ alert('Error deleting category'); }
              });
            });
          }catch(e){console.error(e);}
        });
        </script>
    </div>
</div>
{% endblock %}