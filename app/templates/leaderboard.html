{% extends "base.html" %}

{% block content %}
<div class="container">
    <header>
        <h1>Leaderboard</h1>
        <nav>
            <a href="/">Vote</a>
            <a href="/upload">Upload</a>
            <a href="/stats">Stats</a>
            <a href="/categories">Categories</a>
            <a href="/login" id="auth-link">Login</a>
            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">‚óê</button>
        </nav>
    </header>

    <div class="leaderboard">
        <h2>Top 100 Photos</h2>
        <div class="current-category">
            {% if category_name %}
                <span>Category: <strong>{{ category_name }}</strong></span>
                <a href="/categories" style="margin-left: 10px; font-size: 0.9em;">All Categories</a>
            {% elif selected_category_name %}
                <span>Showing: <strong>{{ selected_category_name }}</strong></span>
                <a href="/categories" style="margin-left: 10px; font-size: 0.9em;">Change Category</a>
            {% else %}
                <span>No category selected</span>
                <a href="/categories" style="margin-left: 10px; font-size: 0.9em;">Select Category</a>
            {% endif %}
        </div>
        <div class="photo-grid" id="leaderboard-grid">
            <!-- Photos will be loaded here -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
    const categoryName = "{{ category_name or '' }}";

    if (categoryName) {
        // Ensure session uses this category
        try {
            await fetch(`/api/categories/select-by-name/${encodeURIComponent(categoryName)}`, {
                method: 'POST',
                credentials: 'include'
            });
        } catch (e) { console.error('select-by-name failed', e); }

        // Rewrite top nav links to category-prefixed paths
        const nav = document.querySelector('header nav');
        if (nav) {
            const links = Array.from(nav.querySelectorAll('a'));
            const relink = (text, leaf) => {
                const a = links.find(x => x.textContent.trim() === text);
                if (a) a.href = `/${encodeURIComponent(categoryName)}/${leaf}`;
            };
            relink('Vote', 'vote');
            relink('Upload', 'upload');
            relink('Leaderboard', 'leaderboard');
        }
    }

    loadLeaderboard(categoryName);
});

async function loadLeaderboard(categoryName) {
    try {
        let url = '/api/photos/leaderboard';
        if (categoryName) url = `/api/photos/leaderboard/${encodeURIComponent(categoryName)}`;
        const res = await fetch(url + '?t=' + Date.now());
        if (!res.ok) throw new Error('Failed to load leaderboard');
        const data = await res.json();
        renderLeaderboard(data);
    } catch (e) {
        console.error('Error loading leaderboard:', e);
    }
}

function renderLeaderboard(entries) {
    const grid = document.getElementById('leaderboard-grid');
    grid.innerHTML = '';
    if (!entries.length) {
        grid.innerHTML = '<div style="padding:20px;color:#666;">No eligible photos yet.</div>';
        return;
    }
    entries.forEach(e => {
        const div = document.createElement('div');
        div.className = 'photo-item';
        div.innerHTML = `
            <div class="photo" style="background:#f0f0f0;">
                <img src="/api/photos/${e.filename}" alt="${e.filename}" />
            </div>
            <div class="meta">
                <span>üëë ${Math.round(e.elo_rating)}</span>
                <span>${e.owner_username}</span>
            </div>
        `;
        grid.appendChild(div);
    });
}
</script>
{% endblock %}
