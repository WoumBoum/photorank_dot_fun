{% extends "base.html" %}

{% block content %}
<div class="container">
    <header>
        <h1>Leaderboard</h1>
        <nav>
            <a href="/">Vote</a>
            <a href="/upload">Upload</a>
            <a href="/stats">Stats</a>
            <a href="/categories">Categories</a>
            <a href="/login" id="auth-link">Login</a>
            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">‚óê</button>
        </nav>
    </header>

    <div class="leaderboard">
        <h2 id="category-question">Top 100 Photos</h2>
        <div class="current-category">
            {% if category_name %}
                <span>Category: <strong>{{ category_name }}</strong></span>
                <a href="/categories" style="margin-left: 10px; font-size: 0.9em;">All Categories</a>
            {% elif selected_category_name %}
                <span>Showing: <strong>{{ selected_category_name }}</strong></span>
                <a href="/categories" style="margin-left: 10px; font-size: 0.9em;">Change Category</a>
            {% else %}
                <span>No category selected</span>
                <a href="/categories" style="margin-left: 10px; font-size: 0.9em;">Select Category</a>
            {% endif %}
        </div>
        <div class="photo-grid" id="leaderboard-grid">
            <!-- Photos will be loaded here -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
    const categoryName = "{{ category_name or '' }}";

    if (categoryName) {
        try {
            const cat = await (await fetch('/api/categories/select-by-name/' + encodeURIComponent(categoryName), { method: 'POST', credentials: 'include' })).json();
            const catData = await (await fetch('/api/categories/' + cat.category_id)).json();
            if (catData && catData.question) document.getElementById('category-question').textContent = catData.question;
        } catch (e) { console.error('failed to fetch category question', e); }
        // Ensure session uses this category
        try {
            await fetch(`/api/categories/select-by-name/${encodeURIComponent(categoryName)}`, {
                method: 'POST',
                credentials: 'include'
            });
        } catch (e) { console.error('select-by-name failed', e); }

        // Rewrite top nav links to category-prefixed paths
        const nav = document.querySelector('header nav');
        if (nav) {
            const links = Array.from(nav.querySelectorAll('a'));
            const relink = (text, leaf) => {
                const a = links.find(x => x.textContent.trim() === text);
                if (a) a.href = `/${encodeURIComponent(categoryName)}/${leaf}`;
            };
            relink('Vote', 'vote');
            relink('Upload', 'upload');
            relink('Leaderboard', 'leaderboard');
        }
    }

    loadLeaderboard(categoryName);
});

async function loadLeaderboard(categoryName) {
    try {
        let url = '/api/photos/leaderboard';
        if (categoryName) url = `/api/photos/leaderboard/${encodeURIComponent(categoryName)}`;
        const res = await fetch(url + '?t=' + Date.now());
        if (!res.ok) throw new Error('Failed to load leaderboard');
        const data = await res.json();
        renderLeaderboard(data);
    } catch (e) {
        console.error('Error loading leaderboard:', e);
    }
}

async function isCategoryOwner(categoryName){
    try{
        if(!categoryName) return false;
        const catRes = await fetch('/api/categories/select-by-name/' + encodeURIComponent(categoryName), {method:'POST', credentials:'include'});
        if(!catRes.ok) return false;
        const cat = await catRes.json();
        const details = await (await fetch('/api/categories/' + cat.category_id)).json();
        const token = localStorage.getItem('token');
        if(!token) return false;
        const meRes = await fetch('/api/users/me', { headers: { Authorization: 'Bearer ' + token }});
        if(!meRes.ok) return false;
        const me = await meRes.json();
        return details && details.owner_id && me && details.owner_id === me.id;
    }catch(e){ return false; }
}

async function renderLeaderboard(entries) {
    const grid = document.getElementById('leaderboard-grid');
    grid.innerHTML = '';
    if (!entries.length) {
        grid.innerHTML = '<div style="padding:20px;color:#666;">No eligible photos yet.</div>';
        return;
    }
    const categoryName = "{{ category_name or '' }}";
    const canModerate = await isCategoryOwner(categoryName);
    entries.forEach((e, idx) => {
        const div = document.createElement('div');
        div.className = 'photo-item';
        const crown = idx === 0 ? 'üëë ' : '';
        div.innerHTML = `
            <div class="photo" style="background:#f0f0f0;">
                <img src="/api/photos/${e.filename}" alt="${e.filename}" />
            </div>
            <div class="meta">
                <span>${crown}${Math.round(e.elo_rating)}</span>
                <span>${e.owner_username}</span>
            </div>
            ${canModerate ? `<button class="btn-delete" data-photo-id="${e.id}">Delete</button>` : ''}
        `;
        if(canModerate){
            const btn = div.querySelector('.btn-delete');
            btn.addEventListener('click', async () => {
                if(!confirm('Delete this photo?')) return;
                try{
                    const token = localStorage.getItem('token');
                    if(!token){ alert('Login required'); return; }
                    const catName = categoryName;
                    const catSel = await (await fetch('/api/categories/select-by-name/' + encodeURIComponent(catName), {method:'POST', credentials:'include'})).json();
                    const res = await fetch(`/api/photos/categories/${catSel.category_id}/photos/${e.id}` , {
                        method: 'DELETE',
                        headers: { Authorization: 'Bearer ' + token }
                    });
                    if(res.ok){ div.remove(); }
                    else{ const d = await res.json().catch(()=>({detail:'Failed'})); alert(d.detail || 'Failed to delete'); }
                }catch(err){ alert('Error deleting'); }
            });
        }
        grid.appendChild(div);
    });
}
</script>
{% endblock %}
