{% extends "base.html" %}

{% block content %}
<div class="container" data-init-app>
    <header>
        <h1>PhotoRank</h1>
        <nav>
            <a href="/leaderboard">Leaderboard</a>
            <a href="/upload">Upload</a>
            <a href="/stats">Stats</a>
            <a href="/categories">Categories</a>
            <a href="/login" id="auth-link">Login</a>
            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">‚óê</button>
        </nav>
    </header>

    <div class="vote-section">
        <h2 id="vote-question">Choose the better photo</h2>
        <div class="current-category">
            {% if selected_category_name %}
                <span>Category: <strong>{{ selected_category_name }}</strong></span>
                <a href="/categories" style="margin-left: 10px; font-size: 0.9em;">Change</a>
            {% else %}
                <span>No category selected</span>
                <a href="/categories" style="margin-left: 10px; font-size: 0.9em;">Select Category</a>
            {% endif %}
        </div>
        <div class="photo-pair">
            <div class="photo-container" id="photo1">
                <img src="" alt="Photo 1" id="img1">
            </div>
            <div class="vs">VS</div>
            <div class="photo-container" id="photo2">
                <img src="" alt="Photo 2" id="img2">
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  const categoryName = "{{ category_name or '' }}";
  if (categoryName) {
    try {
      const res = await fetch(`/api/categories/select-by-name/${encodeURIComponent(categoryName)}`, { method: 'POST', credentials: 'include' });
      // fetch question for the category
      const cat = await (await fetch('/api/categories/' + encodeURIComponent((await res.json()).category_id))).json();
      if (cat && cat.question) {
        document.getElementById('vote-question').textContent = cat.question;
      }
    } catch (e) { console.error('Unable to select category by name', e); }
    try {
      await fetch(`/api/categories/select-by-name/${encodeURIComponent(categoryName)}`, { method: 'POST', credentials: 'include' });
    } catch (e) { console.error('Unable to select category by name', e); }
    const nav = document.querySelector('header nav');
    if (nav) {
      const links = Array.from(nav.querySelectorAll('a'));
      const relink = (text, path) => {
        const a = links.find(x => x.textContent.trim() === text);
        if (a) a.href = `/${encodeURIComponent(categoryName)}/${path}`;
      };
      relink('Vote', 'vote');
      relink('Upload', 'upload');
      relink('Leaderboard', 'leaderboard');
    }
  }
});
</script>
{% endblock %}
